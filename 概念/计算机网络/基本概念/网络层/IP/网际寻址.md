---
aliases:
  - IPv4
  - IPv6
  - 寻址
  - IP
---
## IPv4
### IPv4数据报格式
- 最小首部 = 20B；最大首部：60B
![[Pasted image 20251019202309.png]]
- 版本号：IP协议的版本（区分IPv4与IPv6）
- 首部长度：由于*选项* 为可选，所以需要用首部长度确定IP数据报中数据实际开始的地方
- 服务类型：TOS，让网络能根据业务类型提供不同的服务质量（QoS）
- 数据报长度：总长度，首部 + 数据，以字节计。该字段长16比特，因此IP数据报的理论最大长度为65535字节。（事实上也做不到，这和[[MTU]]有关）
- 标识，标志，片偏移：和IPv4分片有关（IPv6不允许在路由器上对组分片）。初始数据报的最后一个片的标志为0，而其他的都为1；偏移字段指定片应放在初始数据报的哪个位置
- 寿命TTL：确保数据报不会永远在网络上循环，每一台路由器处理数据报时TTL-- ，当 TTL == 0 时数据报被丢弃
- 协议（协议号）：表示[[运输服务（协议）]]，值为 6 标识为[[运输服务（协议）|TCP]]，为 17 标识为 [[运输服务（协议）|UDP]]，89为[[开放最短路优先OSPF|OSPF]]
- 首部校验和：用于检测收到的IP数据报中的比特错误（检验方式：首部每2字节反码求和，求其结果是否 == 首部校验和）
- 源 & 目的地 IP地址：目的地址通过[[DNS：目录服务|DNS]]查得
- 选项（可选）：仅IPv4有
- 数据（有效载荷）
> 由上述可见，一个IP数据报由总长为20字节的首部（不包括选项），这与[[TCP]]报文首段字节数相同（也为20）
### IPv4数据报分片
- IP数据报的长度受[[MTU]]限制
- 由于MTU受数据链路层协议影响，而不同链路由路由器连接，所以IPv4需要路由器做分片，而分成的部分自然称为片
- 为了让路由器提升性能，重组工作由端系统完成
### IPv4编址
- 接口：主机与物理链路之间的边界
- 一个IP地址与一个接口相关联而非主机or路由器
#### IP地址
- 长度：32比特
- 点分十进制记法：每个字节（8bit）用其十进制形式书写，每个字节间用句点隔开（因此就是四个数）
#### 计算方式
- 子网：主机与路由器连成的网络（也称IP网络或直接称为网络）
- 子网掩码：为子网分配的地址，指明在该网络中有哪些IP能用
- 网络号（子网地址）：一个子网的地址，网络号并非具体主机号；网络号 = IP & 子网掩码
- 广播地址：广播地址（子网广播） = 网络号 + 主机位全1（即255），特殊广播地址（有限广播）：255.255.255.255，目的为本地网络内的所有主机，路由器通常不转发（为了避免无限循环），可以让刚启动的设备知道自己在哪个子网中
- 主机位：子网掩码中0的部分；可用主机地址：网络号 + 1~广播-1（不包含0和广播地址）
## IPv6
- 32bit的IP地址空间将被用尽
### IPv6数据报结构
![[Pasted image 20251021145532.png]]
- 扩大的地址容量：IPv6的IP地址为128位，解决了IPv4的32位导致范围太小不够用的问题。引入了[[任播地址]]。
- 简化高效的40字节首部：舍弃了选项，首部成为定长
#### 具体内容
- 版本：字段位6表示位IPv6，但字段为4时并不表示为IPv4
- 流量类型：与IPv4中TOS相似
- 流标签：给属于特殊流的分组加上标签，如更高优先权
- 有效载荷长度：IP数据报中首部后的字节数。IPv6省掉了首部长度
- 下一个首部：标识数据报中的内容需要交付给哪一个运输层协议
- 跳限制：转发数据报的每个路由器对其--，为0时数据报将被丢弃（和IPv4中TTL一个作用）
- 源地址和目的地址：128比特地址（超长）
- 数据：有效载荷部分
#### 与IPv4的差异
- 不再有分片步骤，若数据报太大不能转发则丢掉数据报并向发送方返回一个“分组太大”的[[因特网控制报文协议ICMP|ICMP]]差错报文
- 不再有首部校验和，这是因为IP设计者觉得上层的检验操作够用了（？），并且每台路由器都要重新计算校验和太费时
- 选项：（可能）出现在IPv6的“下一个首部”指出的位置上