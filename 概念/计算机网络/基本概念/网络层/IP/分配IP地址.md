---
aliases:
  - DHCP
  - NAT
---
### 获取一个IP
- 管理员 
	-> 本地ISP 
	-> RIR（区域注册机构，如 APNIC）
	-> IANA（分 IP 地址块）
	-> [[ICANN]]（如NTIA）
### 动态主机配置协议（DHCP）
- 别名：即插即用协议、零配置协议
- 自动将主机连入一个网络
- 通过配置能使主机每次与网络相连都能得到一个相同的地址，或得到一个临时IP地址
- 是客户 - 服务器协议；客户为主机，服务器为DHCP服务器（若没有则用一个路由器（DHCP中继代理）去连接）
- 使用的为[[运输服务（协议）|UDP]]协议，实际上DHCP是应用层协议
#### 连接步骤
![[Pasted image 20251021084612.png]]
1. DHCP服务器发现：新主机通过使用**DHCP发现报文**，使用有限广播地址（255.255.255.255）与DHCP服务器连接（使用[[UDP]]）。此时“本主机”地址为0.0.0.0。
2. DHCP服务器提供：服务器使用**DHCP提供报文**做响应，向主机所在的子网使用有限广播该报文（因为不知道此时是哪个主机向其发起的请求）。其报文包含发现报文事务ID，推荐的IP地址，网络掩码以及IP地址租用期
3. DHCP请求：主机择优选取服务器并提供DHCP请求报文，回显配置的参数
4. DHCP ACK：服务器使用DHCP ACK响应请求报文证实参数
### 网络地址转换（NAT）
```markdown
互联网（Internet / 公共 WAN）
│
├─ 广域网（WAN）
│   ├─ 公共 WAN：全球 ISP 提供，使用公有 IP
│   │   └─ 例：你家上网线路的 ISP 连接
│   └─ 私有 WAN：跨城市或跨办公室的专线网络
│       └─ 例：企业总部 ↔ 分公司专线
│
└─ 局域网（LAN / 局部网络）
    ├─ 私有网络（Private IP）
    │   ├─ 小家庭 LAN
    │   │   ├─ 有线 LAN
    │   │   │   └─ 192.168.1.0/24
    │   │   └─ WLAN（无线 LAN / Wi-Fi）
    │   │       └─ 手机、笔记本、平板连接
    │   ├─ 公司内部 LAN
    │   │   ├─ 10.0.0.0/8 或 172.16.0.0/12
    │   │   └─ VLAN（虚拟局域网）
    │   │       ├─ VLAN 10：办公区
    │   │       └─ VLAN 20：研发区
    │   └─ 连接到 WAN，通过 NAT 上公网
    │       └─ 内网主机使用私有 IP，通过 NAT 映射到公有 IP
    │
    └─ 公有 IP 局域网（较少见）
        └─ 直接用公有 IP 分配给局域网内主机
            └─ 可直接访问互联网，无需 NAT

```
- 私有IP：子网中每台主机的IP地址，表示方法为a.b.c.d/x
- 公有IP：子网的IP，无/x
- 专用网络/具有专用地址的地域私网：仅对该网络中的设备有意义，无法被外界路由
#### NAT的作用
- 使私网之间能够相互沟通，而对外隐藏了家庭网络的内部细节
#### 工作机制
- 路由器对外发送的源IP唯一（但不是子网IP），通常长得和主机地址相似（是主机地址之一）
- NAT通过DHCP服务器得到路由器地址
- 路由器中有一张NAT转换表，并且在表项中包含了端口号及IP地址
- 主机发送报文：主机IP+主机端口 
	-> 路由器转换：路由器IP+路由器端口 
	-> 服务器接收并返回给路由器 
	-> 路由器查NAT转换表，得到主机IP+主机端口 
	-> 发送回给主机
#### 缺点与解决
- 缺点：
	- 端口号用于主机寻址，而NAT+端口映射导致两个主机无法使用同一映射端口
	- 路由器的IP不确定（由DHCP分配），导致请求易出错
- 解决：
	- NAT穿越
	- 通用即插即用UPnP：允许主机发现和配置邻近NAT的协议