### 文件元信息
| inode 结构 | 用途                                                                                              |
| -------- | ----------------------------------------------------------------------------------------------- |
| 文件类型     | 普通文件、目录、链接文件等                                                                                   |
| 权限       | 用户、组、其他用户的读、写、执行权限 (rwxrwxrwx)                                                                  |
| 所有者      | 文件所有者和组的 UID/GID                                                                                |
| 大小       | 文件大小（字节数）                                                                                       |
| 时间戳      | 创建时间、修改时间、访问时间                                                                                  |
| 链接计数     | 硬链接数量，为0时文件被删除                                                                                  |
| 数据块指针    | 指向存储文件内容的磁盘块：<br>• 直接指针：直接指向数据块<br>• 间接指针：指向包含数据块地址的块<br>• 二级间接指针：指向间接指针块<br>• 三级间接指针：指向二级间接指针块 |
- 包含了关于该文件的大部分 **元数据**，但不包括 **文件名** 和 **文件实际内容**
### 进程文件管理
| 层级  | 中文名称       | 维护者      | 作用                                | 关键特点                                                                                                           |
| --- | ---------- | -------- | --------------------------------- | -------------------------------------------------------------------------------------------------------------- |
| 进程级 | 文件描述符表 FDT | 每个进程自己维护 | 记录该**进程**打开的文件描述符（fd → 打开文件表项的映射） | 1. 每个进程独立<br>2. fd 是小的非负整数（0,1,2…）                                                                             |
| 系统级 | 文件打开表 OFT  | 操作系统全局维护 | 记录当前所有被打开**文件**的状态信息              | 1. open 成功就创建表项<br>2. 保存：文件偏移量、访问模式、引用计数等                                                                      |
| 文件级 | inode 表    | 操作系统全局维护 | 存储文件元**数据** + 数据块指针               | 1. 多个进程可共享同一个 inode<br>2. 表示“这个文件本身是谁”<br>3. inode 表是存储所有 inode 的唯一容器<br>4. 文件通过唯一的 **inode 编号**来对应到inode表中的数据 |
![[Pasted image 20260214192830.png]]
#### 系统调用
五个常用的调用：`open`、`close`、`read`、`write`、 `lseek`
open：
- 创建文件描述符，压入FDT表
- 系统文件打开表 引用计数++
- 第一次被打开：iNode从外存中被加载到内存中
close：
- 引用计数为 0：内存中的 **inode** 会被释放
read (fd, buf, count)：将 **文件内容**从内核空间**读取到用户缓冲区**
write (fd, buf, count)：将用户缓冲区的内容**写入内核缓存区**
- 优化策略：延迟写，预存取
lseek：
- 允许显式地移动文件的读写位置（移动指针）
- 实现 随机访问
> [! node] 链接计数
 文件在文件系统中被多少个**目录项**指向的计数（类似重名）
 每当在某个目录里创建一个指向文件的名字（硬链接）时，文件的链接计数就 +1
### 错题
> 若文件 f1 的硬链接为 f2，两个进程分别打开 f1 和 f2，获得对应的文件描述符为 fd1 和 fd2，则下列叙述中，正确的是（ ）。
	Ⅰ. f1 和 f2 的读写指针位置保持相同
	Ⅱ. f1 和 f2 共享同一个内存索引结点
	Ⅲ. fd1 和 fd2 分别指向各自的用户打开文件表中的一项
- 文件偏移量（读写指针位置）存储于 OFT 中，操作系统全局维护
- 因此 f1、f2 虽为存储中同一文件，但依旧认为读写指针位置是不同的
- 同理，各自的用户打开文件表 中 f1、f2 指代的也是不同的对象