**缓存命中** Cache Hit：缓存中存在需要的数据
### 组成
| 部件              | 作用                          |
| --------------- | --------------------------- |
| cache block 缓存块 | 存数据                         |
| cache line      | Tag，Flags，缓存块的统称            |
| Tag             | 和 地址索引index 一起使用，用于判断缓存是否命中 |
#### Cache块大小计算
$$\text{块内地址位数} = \log_2(\text{每个 Cache 块包含的字节数})$$
#### 主存与cache的映射
| 映射方式  | 计算方法                                       | 主缓存关系                    | Cache 块匹配字段 所指代含义                                |
| ----- | ------------------------------------------ | ------------------------ | ------------------------------------------------ |
| 直接映射  | cache 块号 = 主存块号 mod 缓存中的总块数                | 主存块只能映射到缓存中的**一个特定**缓存块  | Cache 块号                                         |
| 全相联映射 | Cache 行 = 任意行                              | 主存中的任何块可映射到缓存中的**任意**缓存块 | 该字段为空， 必须 并行比较所有 cache 块的 tag 才能确定cache块所指代的内存地址 |
| 组相联映射 | 组号 = 主存块号 mod 组数<br>Cache 行 = 组内 N 行中的任意一个 | 缓存块分组，主存块可映射到组中的任意一个缓存块  | 组号                                               |
- N 路组相联表示一个 **组中有 N 个 cache 块**，而不是 cache 中一共有 N 个组
- 关联度：全相联 > 组相联 > 直接映射
- 关联度高，**缓存冲突** 减少，**命中率** 提高，硬件开销 和 访问延迟 增加
### cache 地址结构
> 在获得物理地址后，cache需要将其与内存中的地址相比对，以此确定cache中是否存在该主存块
##### 块内地址 
- 确定访问数据在一个 主存块 / cache 块 内的具体偏移
##### Cache 块匹配字段
- 确定该主存块对应 cache 块位置
##### 标记
- 通过比较 tag 判断是否真正命中
### cache 存储结构
| 结构              | 作用                                     |
| --------------- | -------------------------------------- |
| Valid (有效位)     | - 1位<br>- 标识对象：cache行<br>- 作用：是否存储有效数据 |
| Tag (标记)        | - 与 物理地址 的 tag字段 匹配<br>- 判断是否命中        |
| Dirty (脏位)      | - 1位<br>- 标记数据是否被修改( 回写法 需要)           |
| Reference (访问位) | - 记录访问信息<br>- 用于替换算法(如[[虚拟内存管理\|LRU]]) |
| Block (数据块)     | - 缓存的主存块副本，是实际存储的数据                    |
![[Pasted image 20260225202930.png]]
### 块替换
- 在权相连映射 和 组相连映射中，有块替换算法的需要，用于判断应该替换哪个块
- 整体与[[虚拟内存管理#页置换算法|页面置换算法]] 差不多
### cache 写策略
##### 命中时：
![[Pasted image 20260225204245.png]]
##### 未命中时：
![[Pasted image 20260225204200.png]]
- 写操作**不频繁** 或 写操作不太可能访问同一数据：**直写法** 和 **非写分配法** 
- 写操作**频繁**：**回写法** 和 **写分配法** 
- 直写 + 非分配 → 主存优先  |  回写 + 写分配 → Cache 优先